import gradio as gr
import os
from scipy.misc import imresize

pair_list = ["24","25"]

def updateImage(name):
	textList = []
	text_dir = "input/IVT_text_50/"+name
	textFiles = os.listdir(text_dir);
	numText = len(textFiles);

	for i in range(numText):
		textList.append(str(i+1));

	return f"input/IVT_ir_50/{name}.png", f"input/IVT_vis_50/{name}.png", gr.Dropdown.update(choices=textList,value = textList[0])

def updateText(selectedImage,selectedText):
	
	textFile = open("input/IVT_text_50/"+selectedImage+"/"+ selectedImage + "_"+ selectedText+".txt");
	#文本需要写在同一行里面。
	mp_text = textFile.readline();
	textFile.close();

	return mp_text

def fusionOperation(name,input_text):
	print(name);
	return f"input/{name}_vis.png";

demo = gr.Blocks()

with demo:
	gr.Markdown("# 文本指导图像融合 演示程序")
	gr.Markdown(
    """
	Designed by the PRCI lab 
	- 通过**下拉框选择**一个图像対。
	- 通过**下拉框选择**或**手动输入**对应的文本描述。
	- 点击“开始融合”按钮
    """)


	with gr.Row():
		with gr.Column():			
			dropDownImagePair = gr.Dropdown(label="图像对选择", choices=pair_list)
			btn = gr.Button(value = "开始融合")			
		with gr.Column():			
			dropDownImageText = gr.Dropdown(label="文本选择", choices=['1','2'])				
			textBox = gr.Textbox(label = "文本内容", placeholder="请选择图像的文本描述");										

	with gr.Row():
		input_ir = gr.Image(label="红外图像", image_mode="L", shape=(512,512));
		input_vis = gr.Image(label="可见光图像", image_mode="RGB", shape=(512,512));
		fusedImage = gr.Image(label="融合结果", image_mode="RGB", shape=(512,512));						

		

	btn.click(fusionOperation, inputs=[dropDownImagePair,textBox], outputs=[fusedImage])	

#		with gr.Column():

	dropDownImagePair.change(fn=updateImage, 
		inputs=dropDownImagePair, 
		outputs=[input_ir,input_vis,dropDownImageText])

	dropDownImageText.change(fn=updateText, 
		inputs=[dropDownImagePair,dropDownImageText], 
		outputs=textBox)
	#input_vis = gr.Image.update(value ="");
	fusedImage = gr.Image.update(value ="");

demo.launch()